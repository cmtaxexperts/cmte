<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CM Tax Payment Portal</title>
  <link rel="icon" type="image/png" href="LOGOFAVICON.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root { --primary: #b91c1c; --bg: #fef2f2; }
    body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg); }
    
    .input-field {
        width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 0.5rem;
        background: #f8fafc; outline: none;
    }
    .btn {
        width: 100%; padding: 12px; border-radius: 0.75rem; font-weight: bold;
        text-align: center; display: flex; align-items: center; justify-content: center;
        transition: transform 0.1s; cursor: pointer;
    }
    .btn:active { transform: scale(0.98); }
    .btn-gen { background: #1e293b; color: white; }
    .btn-wa { background: #25D366; color: white; }
    .btn-pay { background: linear-gradient(135deg, #b91c1c, #dc2626); color: white; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(185,28,28,0.3); }

    /* Receipt Card Design */
    #receipt-card {
        background: white; width: 100%; max-width: 400px; padding: 24px; 
        border-radius: 16px; border-top: 6px solid #b91c1c; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin: 0 auto;
    }
  </style>
 </head>
 <body class="min-h-screen flex flex-col items-center py-6 px-4">

  <div id="admin-view" class="w-full max-w-md space-y-4 hidden">
      
      <div class="text-center mb-4">
          <img src="LOGOWEBSITE.png" class="w-16 h-16 mx-auto rounded-xl object-contain shadow-sm mb-2">
          <h1 class="text-xl font-bold text-gray-800">Admin Generator</h1>
      </div>

      <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
          
          <details class="mb-4 bg-red-50 rounded-lg border border-red-100" open>
              <summary class="p-3 text-xs font-bold text-red-800 uppercase cursor-pointer">⚠️ First Time Setup (Click to Open)</summary>
              <div class="p-3 pt-0">
                  <label class="text-[10px] text-gray-500 uppercase font-bold">Paste YOUR Website Link Here:</label>
                  <input type="text" id="pageUrl" class="input-field border-red-200 text-blue-600" placeholder="https://cmtaxexperts.com/payment.html">
                  <p class="text-[10px] text-gray-400 mt-1">*Required for the clickable WhatsApp link to work.</p>
              </div>
          </details>

          <div class="space-y-3">
              <div class="grid grid-cols-3 gap-2">
                  <div class="col-span-2">
                      <label class="text-xs font-bold text-gray-500">Client</label>
                      <select id="clientSelect" class="input-field" onchange="autoFill()">
                          <option value="">Select...</option>
                          <option value="AJWA BUILDERS" data-id="C40001">AJWA BUILDERS</option>
                          <option value="TRUEWELL" data-id="C40002">TRUEWELL</option>
                      </select>
                  </div>
                  <div>
                      <label class="text-xs font-bold text-gray-500">ID</label>
                      <input type="text" id="clientID" class="input-field bg-gray-50" readonly>
                  </div>
              </div>

              <div id="items-list" class="space-y-2">
                  </div>
              
              <button onclick="addItem()" class="w-full py-2 border-2 border-dashed border-blue-200 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-50">+ Add Service</button>

              <div class="flex justify-between items-center pt-3 border-t">
                  <span class="font-bold text-gray-600">Total:</span>
                  <span id="adminTotal" class="text-xl font-bold text-red-700">₹0.00</span>
              </div>
          </div>

          <div class="mt-6 space-y-3">
              <button onclick="generateEverything()" class="btn btn-gen">1. Generate Link & Receipt</button>
              
              <div id="result-area" class="hidden space-y-3">
                  <p class="text-center text-xs text-green-600 font-bold">✅ Generated Successfully!</p>
                  <button onclick="downloadImage()" class="btn bg-gray-800 text-white text-sm">2. Download Receipt Image</button>
                  <a id="wa-btn" href="#" class="btn btn-wa text-sm">3. Send Clickable Link (WhatsApp)</a>
              </div>
          </div>
      </div>
  </div>


  <div id="client-view" class="w-full max-w-md hidden">
      
      <div id="receipt-card">
          <div class="flex items-center justify-between border-b pb-4 mb-4">
              <div>
                  <h2 class="text-xl font-extrabold text-gray-800">CM Tax Experts</h2>
                  <p class="text-[10px] text-red-600 font-bold uppercase tracking-widest">Payment Request</p>
              </div>
              <img src="LOGOWEBSITE.png" class="w-12 h-12 object-contain">
          </div>

          <div class="space-y-1 mb-6 text-sm">
              <div class="flex"><span class="w-20 text-gray-500">Client:</span> <span class="font-bold text-gray-800" id="cardClient">--</span></div>
              <div class="flex"><span class="w-20 text-gray-500">ID:</span> <span class="font-bold text-gray-800" id="cardID">--</span></div>
          </div>

          <div id="cardItems" class="space-y-2 mb-6 text-sm text-gray-700">
              </div>

          <div class="flex justify-between items-center bg-gray-50 p-4 rounded-xl mb-6">
              <span class="font-bold text-gray-600">Total Payable</span>
              <span class="font-bold text-2xl text-red-700" id="cardTotal">₹0.00</span>
          </div>

          <div class="text-center bg-white p-2">
              <div id="qrcode" class="flex justify-center mb-2"></div>
              <p class="text-[10px] text-gray-400 uppercase tracking-widest">Scan with any UPI App</p>
          </div>

          <div id="pay-button-container" class="mt-6 pt-4 border-t border-dashed hidden">
              <a id="final-pay-link" href="#" class="btn btn-pay pulse-animation">
                  Click Here to Pay Now
              </a>
              <p class="text-center text-xs text-gray-400 mt-2">Securely via UPI</p>
          </div>
      </div>
      
      <p id="client-footer" class="text-center text-xs text-gray-400 mt-8 hidden">
          © 2026 CM Tax Experts.
      </p>
  </div>


  <script>
    // --- 0. CONFIGURATION ---
    const ADMIN_UPI = "cmtaxexperts@ybl"; 
    
    // --- 1. INITIALIZATION ---
    window.onload = function() {
        // Check if this is Admin or Client based on URL parameters
        const params = new URLSearchParams(window.location.search);
        
        if(params.has('data')) {
            // CLIENT MODE
            showClientMode(params.get('data'));
        } else {
            // ADMIN MODE
            document.getElementById('admin-view').classList.remove('hidden');
            document.getElementById('client-view').classList.add('hidden'); // We show it briefly later for image gen
            addItem(); // Add first empty row
            
            // Auto-detect URL if possible
            if(!document.getElementById('pageUrl').value) {
                document.getElementById('pageUrl').value = window.location.href.split('?')[0];
            }
        }
    };

    // --- 2. ADMIN LOGIC ---
    function autoFill() {
        const sel = document.getElementById('clientSelect');
        const opt = sel.options[sel.selectedIndex];
        document.getElementById('clientID').value = opt.getAttribute('data-id') || "";
    }

    function addItem() {
        const div = document.createElement('div');
        div.className = 'item-row bg-gray-50 p-2 rounded border flex gap-2 items-center';
        div.innerHTML = `
            <div class="w-full">
                <select class="input-field text-xs p-1 mb-1 item-nature">
                    <option>GST Return Filing</option>
                    <option>Trademark Objection</option>
                    <option>GST Registration</option>
                    <option>Income Tax Return</option>
                    <option>Accounting Fee</option>
                    <option>Other</option>
                </select>
                <div class="flex gap-1">
                    <input type="month" class="input-field text-xs p-1 item-period">
                    <input type="number" class="input-field text-xs p-1 font-bold item-amt" placeholder="0.00" oninput="calcTotal()">
                </div>
            </div>
            <button onclick="this.parentElement.remove();calcTotal()" class="text-red-500 font-bold px-2">×</button>
        `;
        document.getElementById('items-list').appendChild(div);
    }

    function calcTotal() {
        let t = 0;
        document.querySelectorAll('.item-amt').forEach(i => t += parseFloat(i.value || 0));
        document.getElementById('adminTotal').innerText = "₹" + t.toFixed(2);
        return t.toFixed(2);
    }

    // --- 3. GENERATION LOGIC ---
    function generateEverything() {
        const total = calcTotal();
        if(total <= 0) return alert("Please enter amount");

        // Gather Data
        const client = document.getElementById('clientSelect').value || "Client";
        const id = document.getElementById('clientID').value || "";
        
        let items = [];
        let narrationList = [];

        document.querySelectorAll('.item-row').forEach(r => {
            const nature = r.querySelector('.item-nature').value;
            const period = r.querySelector('.item-period').value;
            const amt = parseFloat(r.querySelector('.item-amt').value || 0).toFixed(2);
            if(amt > 0) {
                let pStr = period ? `(${period})` : "";
                items.push({ n: nature, p: pStr, a: amt });
                narrationList.push(nature);
            }
        });

        // Create Encoded Data Package
        const payload = {
            c: client,
            i: id,
            t: total,
            l: items
        };
        const encodedData = btoa(JSON.stringify(payload)); // Base64 encode

        // Render Card for Image Capture
        renderCard(payload);
        
        // Show Card temporarily
        const cardContainer = document.getElementById('client-view');
        cardContainer.classList.remove('hidden');
        
        // Generate Link
        const baseUrl = document.getElementById('pageUrl').value;
        const fullLink = `${baseUrl}?data=${encodedData}`;

        // Setup WhatsApp Button
        const waMsg = `*Payment Request from CM Tax Experts*\n\nClient: *${client}*\nID: ${id}\nTotal: *₹${total}*\n\nClick here to Pay:\n${fullLink}`;
        document.getElementById('wa-btn').href = `https://api.whatsapp.com/send?text=${encodeURIComponent(waMsg)}`;

        document.getElementById('result-area').classList.remove('hidden');
        
        // Scroll to card to see preview
        cardContainer.scrollIntoView({behavior: "smooth"});
    }

    // --- 4. RENDER & CLIENT MODE ---
    function renderCard(data) {
        document.getElementById('cardClient').innerText = data.c;
        document.getElementById('cardID').innerText = data.i;
        document.getElementById('cardTotal').innerText = "₹" + data.t;

        // Render Items
        let html = "";
        let narration = "";
        data.l.forEach(item => {
            html += `<div class="flex justify-between border-b border-gray-100 pb-1 mb-1 last:border-0">
                <span>${item.n} <span class="text-xs text-gray-400">${item.p}</span></span>
                <span class="font-bold">₹${item.a}</span>
            </div>`;
            narration += item.n + ", ";
        });
        document.getElementById('cardItems').innerHTML = html;

        // Generate QR
        if(narration.length > 30) narration = narration.substring(0, 27) + "...";
        const upiLink = `upi://pay?pa=${ADMIN_UPI}&pn=CM%20Tax%20Experts&cu=INR&am=${data.t}&tn=${encodeURIComponent(narration)}`;
        
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById('qrcode'), {
            text: upiLink,
            width: 150, height: 150,
            colorDark: "#000000", colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.M
        });

        // Setup Pay Button (For Client View Only)
        document.getElementById('final-pay-link').href = upiLink;
    }

    function showClientMode(encodedData) {
        try {
            const data = JSON.parse(atob(encodedData));
            
            // Hide Admin, Show Client
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('client-view').classList.remove('hidden');
            
            // Render
            renderCard(data);
            
            // Show Pay Button & Footer
            document.getElementById('pay-button-container').classList.remove('hidden');
            document.getElementById('client-footer').classList.remove('hidden');

        } catch(e) {
            alert("Invalid Payment Link");
            window.location.href = window.location.href.split('?')[0]; // Go back to admin
        }
    }

    // --- 5. IMAGE DOWNLOAD ---
    function downloadImage() {
        // Hide the Pay Button for the image
        document.getElementById('pay-button-container').classList.add('hidden');
        
        const card = document.getElementById('receipt-card');
        html2canvas(card, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Payment_Receipt.png';
            link.href = canvas.toDataURL();
            link.click();
            
            // Restore Pay Button if we are in Client Mode (optional logic, but safe to leave hidden in Admin view)
        });
    }

  </script>
 </body>
</html>
